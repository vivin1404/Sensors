import pyrealsense2 as rs
import numpy as np
import socket

# Configuration
HOST = '192.168.1.2'        # IP address of the onboard system
PORT = 12345                # Port number for communication

def main():
    # Configure depth and color streams
    pipeline = rs.pipeline()
    config = rs.config()
    config.enable_stream(rs.stream.depth, 640, 480, rs.format.z16, 30)
    config.enable_stream(rs.stream.color, 640, 480, rs.format.bgr8, 30)

    # Start streaming
    pipeline.start(config)

    connection = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    connection.connect((HOST, PORT))

    try:
        while True:
            # Wait for a coherent pair of frames: depth and color
            frames = pipeline.wait_for_frames()
            depth_frame = frames.get_depth_frame()
            color_frame = frames.get_color_frame()
            if not depth_frame or not color_frame:
                continue

            # Convert images to numpy arrays
            depth_image = np.asanyarray(depth_frame.get_data())
            color_image = np.asanyarray(color_frame.get_data())

            # Combine depth and color data (this is just an example, modify as needed)
            combined_data = np.hstack((depth_image, color_image))

            # Flatten the array and convert to bytes
            data_bytes = combined_data.tobytes()

            # Sending data to the onboard system
            connection.sendall(data_bytes)
    except KeyboardInterrupt:
        print('Stopping.')
    finally:
        # Stop streaming
        pipeline.stop()
        connection.close()

if __name__ == '__main__':
    main()
